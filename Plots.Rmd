---
title: "R Notebook"
output:
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

Note: Run Charge_Analysis first
# Theme setup
```{r plot designs}
#### PLOT DESIGN ####
# Set color palette
pal <- c("#bb3e03","#ee9b00","yellow", "#e9d8a6","#94d2bd","#0a9396","#005f73")
pal2 <- c("light green", "#90C59B", "#F0C3E6", "#8778D7", "#1e00be", "#001219")
pal3 <- wes_palette("BottleRocket2", 21, type = "continuous")
# Set color background
bck <- "#001219"
# Set theme 
theme_custom <- theme_void()+
  theme(
    plot.margin = margin(1,1,10,1,"pt"),
    plot.background = element_rect(fill="white",color=NA),
    legend.position = "bottom",
    legend.title = element_text(hjust=0.5,color="black",face="bold"),
    legend.text = element_text(color="black")
  )

```
# Descriptive Stats
## Charge points
```{r charge_point_ds}
# Descriptive Stats for Charge points
p2p.data %>%
rename("Latitude" = lat,
       "Longitude" = lon,
       "Car charging" = vehicleTypes.car,
       "Motorbike charging" = vehicleTypes.motorbike,
       "Electic bike charging" = vehicleTypes.bike,
       "Min power range" = powerRange.min,
       "Max power range" = powerRange.max,
       "Fast charger (50kwh+)" = isFastCharge) %>% 
  select(-id, -full_address, -status, -lng) %>%
  stargazer::stargazer(type="latex", style="asr", digits=2, title = "PEV public charge points across Gothenburg city", notes = "Charging point data sources from Place to Plug")

```

## Nodes

```{r nodes_ds}
# Descriptive Stats for nodes in Gothenburg road network
joined_deso.nodes %>% as.data.frame() %>% 
  select(from_node, to_node, knn_distance, dijkstras_distance) %>%
rename("From node" = from_node,
        "Charge point node" = to_node,
        "Nearest neighbour distance" = knn_distance,
       "Shortest path" = dijkstras_distance) %>%
#        "Motorbike charging" = vehicleTypes.motorbike,
#        "Electic bike charging" = vehicleTypes.bike,
#        "Min power range" = powerRange.min,
#        "Max power range" = powerRange.max,
#        "Fast charger (50kwh+)" = isFastCharge) %>%
  # tbl_summary(.,
  #           include = c(nodeID, knn_chargeId, knn_distance, distance_level),
  #           statistic = list(all_continuous() ~ "{mean} ({min}, {max})")) %>%
  #           modify_caption("**Road network nodes in Gothenburg city** (N = {N})")
stargazer::stargazer(type="latex", 
                     style="asr",
                     summary = TRUE,
                     digits=2,
                     title = "Gothenburg road network graph: Descriptive statistics", 
                     notes = "Charging point data sources from Place to Plug")

```
# Map plots: Network
## Road network
```{r map_charge_points}
## Plot map with charge points

nodes <- got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf()
ggplot() +
  #geom_sf(data = got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), col = nodes$component, size=0.5) + 
  #geom_sf(data = gothenburg.subdiv, alpha=0.6, linewidth=0.6, colour="#8778D7", fill="#90C59B") +
  geom_sf(data = got_streets_net %>% activate(edges) %>% as_tibble() %>% st_as_sf(), linewidth=0.2, color = 'grey') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.5, color = "#1e00be", linewidth=0.6) + 
  geom_sf(data = joined_charge_points, size=0.8, aes(color=log(capacity))) +
  # coord_sf(xlim = c(11.71, 12.16), 
  #          ylim = c(57.58, 57.86), 
  #          expand = TRUE, clip="on") +
  labs(title="Public PEV charge points in Gothenburg City",
     subtitle = "",
     fill = "") +
  theme_custom + theme(legend.position = "")


library(tmap)
tmap_mode("view") # set to interactive mode
tm_tiles("CartoDB.Positron") +
  tm_shape(st_as_sf(got_streets_net, "edges")) +
  tm_lines(col = "highway", colorNA = "red")
  #tm_shape(st_as_sf(got_streets_net, "nodes")) +
  #tm_dots(col = st_as_sf(got_streets_net, "nodes")$component)
```

## DeSO areas
```{r map_deso_area}
## Plot map with deso areas
ggplot() +
  #geom_sf(data = water$osm_multipolygons, fill = 'light blue') + 
  geom_sf(data=gothenburg.subdiv, alpha=0.6, linewidth=0.6, colour="#8778D7", fill="#90C59B") +
  #geom_sf(data = got.boundary$osm_multipolygons, linewidth=1, colour="black", fill="transparent") +

 # geom_sf(data = land$osm_lines, color = 'light blue') + 
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = '#1e00be') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.5, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data = charge_points.p2p.geo, size=0.8, color="#1e00be") +
  coord_sf(xlim = c(11.59, 12.21), 
           ylim = c(57.51, 57.86), 
           expand = TRUE, clip="on") +
  # labs(title="Map of demographically statistical areas (DeSOs)",
  #    subtitle = "Gothenburg Municipality",
  #    fill = "") +
  theme_custom + theme(legend.position = "", plot.background = element_rect(fill = "white"))

```

## Nodes

```{r map_nodes}
## Plot map with node points and their color coded distance values
ggplot() +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = '#1e00be') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.8, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data = got.boundary$osm_multipolygons, linewidth=0.5, colour="grey") +
  geom_sf(data=gothenburg.subdiv, alpha=0.2, linewidth=0.6, colour="transparent", fill="#90C59B")+
  geom_sf(data = joined_deso.nodes, size=0.4, aes(color=distance_level)) +
  coord_sf(xlim = c(11.71, 12.16), 
           ylim = c(57.58, 57.86), 
           expand = TRUE, clip = "on") +
  labs(title="Nodes in Gothenburg City road network graph",
     subtitle = "By distance to charge point",
     color = "") +
  scale_color_manual(values= wes_palette(7, name = "Zissou1", type = "continuous")) +
  theme_custom + 
  theme(legend.key.width = unit(1, 'cm'))
```

## Foreign background

```{r map_deso_foreign_percentage}
foreign <- deso.demographics %>% select(deso, foreign)
got.sub.demo <- gothenburg.subdiv.merged %>% merge(., foreign, by="deso")
# Plot percentage foreign background by DeSO on heat map
ggplot() +
  #geom_sf(data=gothenburg.subdiv) +
  geom_sf(data = got.boundary$osm_multipolygons, linewidth=0.5, colour="grey") +
  geom_sf(data=got.sub.demo, alpha=0.7, aes(fill=round(foreign, 2)), linewidth=0.8) +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = 'black') +
  coord_sf(xlim = c(11.71, 12.16), 
           ylim = c(57.57, 57.86), expand = TRUE, clip = "on") +
  labs(title="Percentage of residents with a foreign background",
       subtitle = "By DeSO subdivision",
       fill = "") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom
```

# Example network plots

```{r example_graph}
p1 <- st_point(c(0, 1))#
p2 <- st_point(c(2, 1))

#l2
p3 <- st_point(c(2, 2))
p4 <- st_point(c(2, 1))
p5 <- st_point(c(2, -2))
p6 <- st_point(c(2, -3))

#l3
p7 <- st_point(c(0, -2))

#l4
p8 <- st_point(c(4, -2))

l1 = st_sfc(st_linestring(c(p1, p2)))#
l2 = st_sfc(st_linestring(c(p3, p2, p4, p5, p6)))#
l3 = st_sfc(st_linestring(c(p7, p5)))#
l4 = st_sfc(st_linestring(c(p5, p8)))#
l5 = st_sfc(st_linestring(c(p7, p4)))

lines = c(l1, l2, l3, l4, l5)

edge_colors <- function(x) rep(brewer.pal(n=10, name="Set3")[-2], 2)[c(1:ecount(x))]

net <- as_sfnetwork(lines, directed=FALSE)
net <- net %>% activate(nodes) %>% mutate(nodeId = c(1:n()))
net <- net %>% activate(edges) %>% mutate(length = edge_length())
net.nodes <- net %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net, "edges"), col = edge_colors(net), lwd = 1.5) +
  geom_sf(data = st_geometry(net, "nodes"), pch = 20, size = 9, col="black") +
  geom_sf_text(data = net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.nodes$nodeId, col="white") +
  theme_void()


test_path <- shortest_paths(
  graph = net,
  from = 7,
  to = 1,
  #mode = "all",
  output="both",
  algorithm ="dijkstra", # Ensure to use Dijkstra's algorithm
  weights = net %>% activate(edges) %>% pull(length)
)

test_path_graph <- net %>%
  subgraph.edges(eids = test_path$epath %>% unlist()) %>%
  as_tbl_graph()

test_path_graph_df <- test_path_graph %>% as_data_frame(., what="vertices")

#Calculate the total length of the path
test_path_graph %>%
  activate(edges) %>%
  as_tibble() %>%
  summarise(length = sum(length))

path.nodes <- test_path_graph %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net, "edges"), col = edge_colors(net), lwd = 1.5) +
  geom_sf(data = test_path_graph %>% activate(edges) %>% as_tibble( ) %>% st_as_sf(), lwd=3, col="#bb3e03") +
  geom_sf(data = st_geometry(net, "nodes"), pch = 20, size = 9, col="black") +
  geom_sf_text(data = net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
                label = net.nodes$nodeId, col="white") +
  geom_sf_text(data = test_path_graph %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
                label = path.nodes$nodeId, col="white") +
  theme_void()

### Subdivided

net.simple <- as_sfnetwork(lines, directed=FALSE)
net.simple <- net.simple %>% 
  activate("edges") %>% 
  arrange(edge_length()) %>%
  filter(!edge_is_multiple()) %>%
  filter(!edge_is_loop())

net.subdivision <- convert(net.simple, to_spatial_subdivision)
net.subdivision <- net.subdivision %>% activate(edges) %>% mutate(length = edge_length())
net.subdivision <- net.subdivision %>% activate(nodes) %>% arrange(.tidygraph_node_index) %>% mutate(nodeId = c(1:n()))
net.subdivision.nodes <- net.subdivision %>% activate(nodes) %>% as_tibble()


ggplot() +
  geom_sf(data = st_geometry(net.subdivision, "edges"), col = edge_colors(net.subdivision), lwd = 1.5) +
  geom_sf(data = st_geometry(net.subdivision, "nodes"), pch = 20, size = 9, col="black") +
  geom_sf_text(data = net.subdivision %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.subdivision.nodes$nodeId, col="white") +
  theme_void()


test_path <- shortest_paths(
  graph = net.subdivision,
  from = 7,
  to = 1,
  #mode = "all",
  output="both",
  algorithm ="dijkstra", # Ensure to use Dijkstra's algorithm
  weights = net.subdivision %>% activate(edges) %>% pull(length)
)

test_path_graph <- net.subdivision %>%
  subgraph.edges(eids = test_path$epath %>% unlist()) %>%
  as_tbl_graph()

test_path_graph_df <- test_path_graph %>% as_data_frame(., what="vertices")

#Calculate the total length of the path
test_path_graph %>%
  activate(edges) %>%
  as_tibble() %>%
  summarise(length = sum(length))

path.nodes <- test_path_graph %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net.subdivision, "edges"), col = edge_colors(net.subdivision), lwd = 1.5) +
  geom_sf(data = test_path_graph %>% activate(edges) %>% as_tibble( ) %>% st_as_sf(), lwd=3, col="#bb3e03") +
  geom_sf(data = st_geometry(net.subdivision, "nodes"), pch = 20, size = 9, col="black") +
  geom_sf_text(data = net.subdivision %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.subdivision.nodes$nodeId, col="white") +
  geom_sf_text(data = test_path_graph %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = path.nodes$nodeId, col="white") +
  theme_void()

```

# Results

## Distance

### All DeSO

```{r}
normalize <- function(value, min, max) {
	normalized <- (value - min) / (max - min);
	return(normalized)
}
```

 
```{r map_deso_averages}
# Plot average distances by DeSO on cloropleth map
ggplot() +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.6) +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.7, aes(fill=log(avg_accessibility)), linewidth=0.8) +
   labs(title="Average distance to public charging point in Gothenburg",
       subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Average accessibility",
       caption = str_wrap("Values are shown in a logorithmic scale for better representation of the variences across the DeSOs. X DeSO areas had a average accessibility of zero, which returned infinate in the logorithmic scale. These Nas are shown as the lowest color on the color scale (blue)", 100)) +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous"), 
                       #labels = c(0, 0.25, 0.5, 0.75, 1),
                       na.value="#3B9AB2") +
  theme_custom

```

### Rentals
```{r map_rental_desos}
# Filter out desos by rental majority areas
got.sub.new.rentals <- gothenburg.subdiv.merged %>% 
  filter(deso %in% deso.demographics.rentals$deso)
# Plot average distances by DeSO on heat map
ggplot() +
  #geom_sf(data=gothenburg.subdiv) +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.6) +
  geom_sf(data=got.sub.new.rentals, alpha=0.7, aes(fill=(log(avg_accessibility))), linewidth=0.8) +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = 'black') +
  coord_sf(xlim = c(11.71, 12.16), 
           ylim = c(57.57, 57.86), expand = TRUE, clip = "on") +
  labs(title="Average distance to public charging point in Gothenburg",
       subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Distance") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom
```


### Owner occupied
```{r map_owner_occupied_desos}
# Filter out desos by rental majority areas
got.sub.new.owner.occupied <- gothenburg.subdiv.merged %>% 
  filter(deso %in% deso.demographics.owner.occupied$deso)
# Plot average distances by DeSO on heat map
ggplot() +
  #geom_sf(data=gothenburg.subdiv) +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.6) +
  geom_sf(data=got.sub.new.owner.occupied, alpha=0.7, aes(fill=log(avg_accessibility)), linewidth=0.8) +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = 'black') +
  coord_sf(xlim = c(11.71, 12.16), 
           ylim = c(57.57, 57.86), expand = TRUE, clip = "on") +
  labs(title="Average distance to public charging point in Gothenburg",
       subtitle = "DeSO subdivisions with min 75% owner-occupied housing",
       fill = "Distance",
       caption = str_wrap("Owner-occupied included all housing that is with owned outright by the resident, often a freestanding house and land (äganderätt), as well as owned apartments with a building managed by a body corporate (bostadsrätt). In both of these housing types, the residents have some or full control over facilities available to residents.", 100)) +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom
```

## Accessibility

```{r map_rental_desos}
# Plot average accessibility by DeSO on map
ggplot() + 
    geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.4) +
  geom_sf(data = got.sub.new.rentals, aes(fill=(log(avg_accessibility))), size=0.4, linewidth=0.2) +
  labs(title="Average accessibility to public charging point in Gothenburg",
       subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Distance") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
theme_custom

```
 
## Descriptive Stats

```{r demographics_ds}
# Descriptive stats for full demographic data
deso.demographics %>% 
  rename("Nodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "High school" = gymnasium,
         "Middle school" = middle_school,
         "Tertiary education (< 3 yrs)" = post_gymnasium_less_than_3,
         "Tertiary education (3 + yrs)" = post_gymnasium_more_than_3,
         "Rental apartment" = hyresrätt, 
         "Owner-occupied apartment" = bostadsrätt, 
         "Owner-occupied house" = äganderätt,
         "Avg cars per household" = cars_per_household,
         "Total cars on road" = bilar_i_trafik) %>%
  select(-deso, -regso, -education_missing, -avg_accessibility, -avg_dijk_dist, -avg_euc_dist) %>% 
  stargazer::stargazer(type="latex", 
                       style="asr",
                       digits=2,
                       omit.summary.stat = c("N", "Sd"), 
                       title = "DeSO demographic data for Gothenburg, Sweden", 
                       notes = "DeSO demographic data from 2022.")
  # tbl_summary(., include=c(-ages),
  #             statistic = list(all_continuous() ~ "{mean} ({min}, {max})")) %>%
  #             modify_footnote(all_stat_cols() ~ "Mean (Minimun) (Maximum)") %>%
  #             modify_caption("**Gothenburg city DeSO demographic data (All)** (N = {N})")
```


```{r demographics_ds}
# Sample of summarised demographic data
deso.demographics %>% arrange(desc(total_households)) %>% head() %>%
  rename(#"Nodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "Swedish background %" = swedish,
         "Foreign background %" = foreign,
         "High school %" = gymnasium,
         "Middle school %" = middle_school,
         "Tertiary education (< 3 yrs) %" = post_gymnasium_less_than_3,
         "Tertiary education (3 + yrs) %" = post_gymnasium_more_than_3,
         "Rental apartment %" = hyresrätt, 
         "Owner-occupied apartment %" = bostadsrätt, 
         "Owner-occupied house %" = äganderätt,
         "Avg cars per household" = cars_per_household,
         "Total cars on road" = bilar_i_trafik) %>%
  select(-nodes, -education_missing, -avg_accessibility, -avg_dijk_dist, -ages) %>% 
  stargazer::stargazer(type="latex", style="asr", digits = 2, digits.extra = 0,  flip = TRUE,  summary=FALSE, 
                       title = "DeSO demographic data for Gothenburg municipality: Sample set", notes = "DeSO demographics are from 2022.")
```

```{r demographics_rentals_ds}
# Descriptive stats for rental demographic data
deso.demographics.rentals %>% 
  rename("Nodes" = nodes, 
         "Average distance to PEV charge point" = avg_dijk_dist,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "High school" = gymnasium,
         "Middle school" = middle_school,
         "Post high school (less than 3 yrs)" = post_gymnasium_less_than_3,
         "Post high school (3 or more yrs)" = post_gymnasium_more_than_3,
         "Rental apartment" = hyresrätt, 
         "Owner-occupied apartment" = bostadsrätt, 
         "Owner-occupied house" = äganderätt,
         "Total cars on road" = bilar_i_trafik,
         "Avg cars per household" = cars_per_household) %>%
  select(-deso, -regso, -education_missing) %>% 
  tbl_summary(., include=c(-ages),
              statistic = list(all_continuous() ~ "{mean} ({min}, {max})")) %>%
              modify_footnote(all_stat_cols() ~ "Mean (Minimun) (Maximum)") %>%
              modify_caption("**Gothenburg city DeSO demographic data
                             (areas with at least 75% rental apartment housing)** (N = {N})")
```

### Knn distance
```{r sample_knn_distance}
# Sample of summarised demographic data
closest_charge_sf  %>%
  rownames_to_column(., "from") %>% mutate(to = charge_id) %>% 
  filter(distance < 1000) %>%
  head() %>% 
  select(from, to, distance) %>%
  stargazer::stargazer(type="latex", 
                       style="asr",
                       summary=FALSE, 
                       rownames = FALSE,
                       digits = 0,
                       title = "Euclidean distance between points using K nearest neighbour", 
                       notes = "Note: Nearest neighbour distance is represented in meters")

```

```{r sample_dijk_distance}
# Sample of summarised demographic data Dijkstra's distance
joined_deso.nodes %>% 
  filter(dijkstras_distance < 1000) %>%
  as.data.frame() %>%
  mutate(to = chargeId, from = from_node) %>%
  mutate(dijkstras_distance = as.numeric(dijkstras_distance)) %>%
  select(from, to, dijkstras_distance) %>%
  drop_na() %>% head() %>%
  stargazer::stargazer(type="latex", 
                       style="asr",
                       summary = FALSE, 
                       rownames = FALSE,
                       digits = 0,
                       title = "Shortest distance between points using Dijkstra's algorithm", 
                       notes = "Note: Shortest distance is represented in meters")

```


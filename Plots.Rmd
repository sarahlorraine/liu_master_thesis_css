---
title: "R Notebook"
output:
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

Note: Run Charge_Analysis first
# Theme setup
```{r plot designs}
library(extrafont)
# font_import() # First time import of local fonts
# loadfonts(device = "win")
windowsFonts()
#### PLOT DESIGN ####
# Set color palette
pal <- c("#bb3e03","#ee9b00","yellow", "#e9d8a6","#94d2bd","#0a9396","#005f73")
pal2 <- c("light green", "#90C59B", "#F0C3E6", "#8778D7", "#1e00be", "#001219")
pal3 <- wes_palette("BottleRocket2", 21, type = "continuous")
# Set color background
bck <- "#001219"
# Set theme 
theme_custom_map <- theme_void() +
  theme(
    plot.margin = margin(1,1,10,1,"pt"),
    plot.background = element_rect(fill="white",color=NA),
    legend.position = "bottom",
    text = element_text(size = 12, family = "Cambria"),
    legend.title = element_text(color="black"),
    legend.text = element_text(color="black")
  )

theme_custom <- theme_classic() +
  theme(
    plot.margin = margin(1,1,10,1,"pt"),
    plot.background = element_rect(fill="white",color=NA),
    legend.position = "bottom",
    text = element_text(size = 16, family = "Cambria"),
    legend.title = element_text(color="black"),
    legend.text = element_text(color="black")
  )


```
# Descriptive Stats
## Charge points
```{r charge_point_ds}
# Descriptive Stats for Charge points
joined_charge_points %>% 
  mutate(X = (joined_charge_points %>% st_coordinates() %>% as_tibble())$X,
         Y = (joined_charge_points %>% st_coordinates() %>% as_tibble())$Y) %>%
  mutate(fee = factor(ifelse(is.na(`parking:fee`), "no", `parking:fee`))) %>%
  as.data.frame() %>%
  ggplot() + 
  geom_rect(aes(xmin=1, 
                xmax=43,
                ymin=0,
                ymax=max(capacity)+1), 
            fill="#808080",#wes_palette(n=1,"GrandBudapest1"), 
            alpha=0.01) +
  geom_rect(aes(xmin=46, 
                xmax=max(powerRange.max)+5,
                ymin=0,
                ymax=max(capacity)+1), 
            fill="gray",#wes_palette(n=1,"Zissou1"), 
            alpha=0.01) +
  geom_text(x=23,
            y = 52.5,
            label=paste("n =", nrow(joined_charge_points %>% filter(powerRange.max <= 43)))) +
  geom_text(x=200,
            y = 52.5,
            label=paste("n =", nrow(joined_charge_points %>% filter(powerRange.max > 43)))) +
  #geom_vline(xintercept=3, color="dark green") +
  geom_point(aes(x=powerRange.max, y=capacity), size=2) + 
  labs(y="Capacity",
       x= "Maximum power KW",
       color="Parking fee") +
  scale_y_continuous(breaks = seq(0, max(joined_charge_points$capacity), 5)) +
  scale_x_continuous(breaks = seq(0, max(joined_charge_points$powerRange.max), 25)) +
  scale_color_manual(wes_palette(n=1, name = "Zissou1")) +
  theme_custom
  #select("Latitude", "Longitude", "Capacity", "Parking fee", -geometry) %>%
  #stargazer::stargazer(type="latex", style="asr", summary = TRUE,title = "PEV public charging points across Gothenburg city", notes = "Charging point data sourced from Place to Plug and Open Street Maps")

```

```{r}
joined_charge_points %>% as.data.frame() %>%
  select(capacity, powerRange.min, powerRange.max, isFastCharge) %>%
rename("Capacity" = capacity,
        "Power Range (min)" = powerRange.min,
        "Power Range (max)" = powerRange.max,
        "Fast Charge" = isFastCharge) %>%
stargazer::stargazer(type="latex", 
                     style="asr",
                     summary = TRUE,
                     digits=2,
                     title = "Gothenburg public charging point data: Descriptive statistics")

```


## Nodes

```{r nodes_ds}
# Descriptive Stats for nodes in Gothenburg road network
joined_deso.nodes %>% as.data.frame() %>% 
  select(from_node, to_node, travel_time, dijkstras_distance) %>%
rename("From node" = from_node,
        "Charge point node" = to_node,
        "Nearest neighbour distance" = knn_distance,
        "Shortest path" = dijkstras_distance) %>%
stargazer::stargazer(type="latex", 
                     style="asr",
                     summary = TRUE,
                     digits=2,
                     title = "Gothenburg road network graph: Descriptive statistics", 
                     notes = "Charging point data sourced from Place to Plug and Open Street Maps")

```
# Map plots: Network

## Gothenburg

```{r}
# Gothenburg boundary map
outer.boundary <- gothenburg.subdiv %>%
  group_by(kommunnamn) %>% 
  summarise(across(geom, ~ sf::st_union(.)), .groups = "drop")

got_map <- get_tiles(outer.boundary, provider = "OpenStreetMap", zoom = 13)
ggplot() +
  geom_spatraster_rgb(data = got_map) +
  geom_sf(data = outer.boundary, fill=NA, linewidth=1.2) + 
  geom_sf_label(data = central_station, label = central_station$landmark, nudge_y = 0.015, alpha=0.6, label.size = 0.5) +
  geom_sf(data =central_station, size=2) + theme_void()
```

## Road network

```{r map_roads}
## Plot road network

ggplot() +
  #geom_sf(data = got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), col = nodes$component, size=0.5) + 
  geom_sf(data = gothenburg.subdiv.merged, alpha=0.6, linewidth=1, fill="darkgrey", color="darkgrey") +
  geom_sf(data = gothenburg.subdiv.merged, alpha=1, linewidth=0.6, fill="#eeeeee", color="#eeeeee") +
  geom_sf(data = got_streets_net %>% activate(edges) %>% as_tibble() %>% st_as_sf(), linewidth=0.2, color = '#8778D7') +
  geom_sf(data = st_filter(main_streets$osm_lines, gothenburg.subdiv.merged), alpha=0.5, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data = joined_charge_points, aes(size=(capacity), color=capacity)) +
  scale_color_distiller(palette = "Oranges", breaks = c(1, 25, 50, 75, 100), guide="none") +
  scale_size(breaks = c(1, 25, 50, 75, 100)) +
  labs(#title="Public PEV charging points in Gothenburg municipality",
     subtitle = "",
     color = "",
     size = "Capacity") + theme_custom_map
```
### With Charge Points
```{r map_charge_points}
## Plot map with charge points

nodes <- got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf()
ggplot() +
  #geom_sf(data = got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), col = nodes$component, size=0.5) + 
  geom_sf(data = gothenburg.subdiv.merged, alpha=0.6, linewidth=0.6, colour="#505050", fill=NA) +
  geom_sf(data = got_streets_net %>% activate(edges) %>% as_tibble() %>% st_as_sf(), linewidth=0.2, color = 'grey') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.5, color = "#1e00be", linewidth=0.6) + 
  geom_sf(data = joined_charge_points, aes(size=(capacity), color=capacity)) +
  scale_color_distiller(palette = "Oranges", breaks = c(1, 25, 50, 75, 100), guide="none") +
  scale_size(breaks = c(1, 25, 50, 75, 100)) +
  labs(#title="Public PEV charging points in Gothenburg municipality",
     subtitle = "",
     color = "",
     size = "Capacity") + theme_custom_map
```

```{r map_road_network}
map_data.sf <- got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf()
got.central <- 
## Plot map with zoom
inset_map <- ggplot() + 
  geom_sf(data = us_states_2163, fill = "white") + 
  geom_sf(data = north_carolina_2163_bb, fill = NA, color = "yellow", size = 1.2) +
  theme_void()

# main panel
main_map <- ggplot() + 
  geom_sf(data = got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), col="#90C59B", size=0.2) +
  labs(#title="Public PEV charging points in Gothenburg municipality",
     subtitle = "",
     color = "",
     size = "Capacity") + theme_custom
# map
gg_inset_map1 <- cowplot::ggdraw() +
  coord_equal(xlim = c(0, 20), ylim = c(0, 20), expand = FALSE) +
  annotation_custom(ggplotGrob(inset), xmin = 0, xmax = 10, ymin = 10, ymax = 20) +
  annotation_custom(ggplotGrob(main), xmin = 0, xmax = 20, ymin = 0, ymax = 10) +
  geom_segment(aes(x = 8.9, xend = 19, y = 14.4, yend = 9.2), color = "yellow", size = 1.2) +
  geom_segment(aes(x = 7.5, xend = 1, y = 14.4, yend = 9.2), color = "yellow", size = 1.2)
ggplot() +
  geom_sf(data = got_streets_net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), col="#90C59B", size=0.2) + 
  #geom_sf(data = gothenburg.subdiv, alpha=0.6, linewidth=0.6, colour="#8778D7", fill="#90C59B") +
  #geom_sf(data = got_streets_net %>% activate(edges) %>% as_tibble() %>% st_as_sf(), linewidth=0.2, color = 'grey') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.5, color = "black", linewidth=0.6) + 
  #geom_sf(data = joined_charge_points, aes(size=(capacity), color=capacity)) +
  scale_color_distiller(palette = "Oranges", breaks = c(1, 25, 50, 75, 100), guide="none") +
  scale_size(breaks = c(1, 25, 50, 75, 100)) +
  labs(#title="Public PEV charging points in Gothenburg municipality",
     subtitle = "",
     color = "",
     size = "Capacity") + theme_custom_map
```

```{r interactive_map}
got_streets_net.unfiltered %>% activate(edges) %>% filter(from == 7790 | to==7790) %>% filter(highway== "tertiary") %>% as_tibble() %>% st_as_sf() %>% plot()

library(tmap)
tmap_mode("view") # set to interactive mode
tm_tiles("CartoDB.Positron") +
  tm_shape(st_as_sf(got_streets_net, "edges")) +
  tm_lines(col = "highway", colorNA = "red") +
  tm_shape(st_as_sf(got_streets_net.unfiltered, "nodes"))+
  tm_dots(col = st_as_sf(got_streets_net, "nodes")$id)
```

## DeSO areas
```{r map_deso_area}
deso_map_data <- gothenburg.subdiv.merged %>% merge(., deso.demographics, by="deso")

deso_map.boundary <- gothenburg.subdiv.merged %>%
  group_by(kommunnamn) %>% 
  summarise(across(geometry, ~ sf::st_union(.)), .groups = "drop")

deso_map.boundary_map <- get_tiles(deso_map.boundary, provider = "OpenStreetMap", zoom = 13)
  
## Plot map with deso areas
ggplot() +
  geom_spatraster_rgb(data = deso_map.boundary_map, alpha=0.5) +
  geom_sf(data=deso_map_data, linewidth=0.7, colour="#505050",fill="#8778D7", aes(alpha=pop)) +
  #geom_sf_text(data = gothenburg.subdiv, label=gothenburg.subdiv$deso, 
  #             size=(scale(center=FALSE, as.integer(gothenburg.subdiv$area)) / 2), color="#1e00be") +
  labs(#title="Map of demographically statistical areas (DeSOs)",
     #subtitle = "Gothenburg Municipality",
     alpha = "Population") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom_map# + theme(legend.position = "none")
```

## RegSO areas
```{r map_RegSO_area}
regso_map_data <- gothenburg.subdiv.merged %>% filter(grepl("Kortedala", regso)) %>% merge(., deso.demographics, by="deso")

regso_map.boundary <- regso_map_data %>%
  group_by(kommunnamn) %>% 
  summarise(across(geometry, ~ sf::st_union(.)), .groups = "drop")

regso_map.grouped <- regso_map_data %>%
  group_by(regso.x) %>% 
  summarise(across(geometry, ~ sf::st_union(.)), .groups = "drop")

regso_map.boundary_map <- get_tiles(regso_map.boundary, provider = "OpenStreetMap", zoom = 14)
  
## Plot map with deso areas
ggplot() +
  geom_spatraster_rgb(data = regso_map.boundary_map, alpha=0.5) +
  geom_sf(data=regso_map_data, linewidth=0.7, colour="#ffffff", fill="#8778D7", alpha=0.5) +
  geom_sf(data=regso_map.grouped, linewidth=0.7, colour="#001219", fill=NA, alpha=0.6) +
  geom_sf_label(data = regso_map.grouped, label=regso_map.grouped$regso.x, size=3.5, alpha=0.6, nudge_x=0.002, nudge_y=-0.0) +
  # labs(#title="Map of demographically statistical areas (DeSOs)",
  #    #subtitle = "Gothenburg Municipality",
  #    alpha = "Population") +
  theme_custom_map# + theme(legend.position = "none")
```

## Exposed areas
```{r map_deso_area}
## Plot map with deso areas and exposed areas
ggplot() +
  geom_sf(data=gothenburg.subdiv, alpha=0.6, linewidth=0.6, colour="dark gray", fill="#eeeeee") +
  geom_sf_label(data = utsatta_områden, label = utsatta_områden$neighbourhood, nudge_y = 0.007, alpha=1) +
  geom_sf(data = utsatta_områden, size=3.5,  colour="#8778D7") +
  geom_sf(data = utsatta_områden, size=2.5, aes(color=factor(utsatta_områden$risk_level))) +
  #geom_sf_text(data = gothenburg.subdiv, label=gothenburg.subdiv$deso, 
  #             size=(scale(center=FALSE, as.integer(gothenburg.subdiv$area)) / 2), color="#1e00be") +
  labs(#title="Map of demographically statistical areas (DeSOs)",
     #subtitle = "Gothenburg Municipality",
     color = "Risk category") +
  scale_color_manual(values=c("#F2AD00","#F98400","#FF0000")) +
  theme_custom_map# + theme(legend.position = "none")
```

## Nodes

```{r map_nodes}
deso_zoom <- gothenburg.subdiv %>% filter(deso == "1480C2240") %>% st_bbox()
regso.list
from <- c(deso_zoom$xmin, deso_zoom$xmax, deso_zoom$ymin, deso_zoom$ymax)
# Names xmin, xmax, ymin, ymax are optional:
to <- c(xmin = 12.1, xmax = 12.2, ymin = 57.70, ymax = 57.84)

## Plot map with node points and their color coded distance values
ggplot() +
  geom_sf(data = got_streets_net %>% activate("edges") %>% as_tibble() %>% st_as_sf(), linewidth=0.2, color = '#808080') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.8, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data=gothenburg.subdiv, alpha=0.2, linewidth=0.6, colour="transparent", fill="#90C59B")+
  geom_sf(data = joined_deso.nodes, size=0.4, aes(color=travel_time)) +
  labs(#title="Nodes in Gothenburg City road network graph",
     #subtitle = "By distance to charge point",
     color = "Travel time (minutes)") +
  scale_color_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom_map +
  geom_magnify(from = from, to = to)

```

```{r histogram_nodes}

## Plot map with node points and their color coded distance values
ggplot() +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = '#1e00be') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.8, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data = got.boundary$osm_multipolygons, linewidth=0.5, colour="grey") +
  #geom_sf(data=gothenburg.subdiv, alpha=0.2, linewidth=0.6, colour="transparent", fill="#90C59B")+
  geom_histogram(data = joined_deso.nodes, 
                 fill=wes_palette(n=1, name = "Zissou1"), 
                 aes(x=travel_time), binwidth = 0.09) +
  labs(#title="Nodes in Gothenburg City road network graph",
     #subtitle = "By distance to charge point",
     x = "Travel time (minutes)",
     y="") +
  scale_x_continuous(breaks=c(seq(0, 30, 5))) +
  theme_custom
```

## Foreign background

```{r map_deso_foreign_percentage}
foreign <- deso.demographics %>% select(deso, foreign)
got.sub.demo <- gothenburg.subdiv.merged %>% merge(., foreign, by="deso")
# Plot percentage foreign background by DeSO on heat map
ggplot() +
  #geom_sf(data=gothenburg.subdiv) +
  geom_sf(data=got.sub.demo, alpha=0.7, aes(fill=round(foreign, 2)), linewidth=0.8) +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = 'black') +
  coord_sf(xlim = c(11.71, 12.16), 
           ylim = c(57.57, 57.86), expand = TRUE, clip = "on") +
  labs(title="Percentage of residents with a foreign background",
       subtitle = "By DeSO subdivision",
       fill = "") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous")) +
  theme_custom_map
```

# Example network plots

```{r example_graph}
p1 <- st_point(c(0, 1))#
p2 <- st_point(c(2, 1))

#l2
p3 <- st_point(c(2, 2))
p4 <- st_point(c(2, 1))
p5 <- st_point(c(2, -2))
p6 <- st_point(c(2, -3))

#l3
p7 <- st_point(c(0, -2))

#l4
p8 <- st_point(c(4, -2))

l1 = st_sfc(st_linestring(c(p1, p2)))#
l2 = st_sfc(st_linestring(c(p3, p2, p4, p5, p6)))#
l3 = st_sfc(st_linestring(c(p7, p5)))#
l4 = st_sfc(st_linestring(c(p5, p8)))#
l5 = st_sfc(st_linestring(c(p7, p4)))

lines = c(l1, l2, l3, l4, l5)

edge_colors <- function(x) rep(brewer.pal(n=10, name="Set3")[-2], 2)[c(1:ecount(x))]

net <- as_sfnetwork(lines, directed=FALSE)
net <- net %>% activate(nodes) %>% mutate(nodeId = c(1:n()))
net <- net %>% activate(edges) %>% mutate(length = edge_length())
net.nodes <- net %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net, "edges"), col = edge_colors(net), lwd = 1.5) +
  geom_sf(data = st_geometry(net, "nodes"), pch = 20, size = 12, col="black") +
  geom_sf_text(data = net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.nodes$nodeId, col="white") +
  theme_void()


test_path <- shortest_paths(
  graph = net,
  from = 7,
  to = 1,
  #mode = "all",
  output="both",
  algorithm ="dijkstra", # Ensure to use Dijkstra's algorithm
  weights = net %>% activate(edges) %>% pull(length)
)

test_path_graph <- net %>%
  subgraph.edges(eids = test_path$epath %>% unlist()) %>%
  as_tbl_graph()

test_path_graph_df <- test_path_graph %>% as_data_frame(., what="vertices")

#Calculate the total length of the path
test_path_graph %>%
  activate(edges) %>%
  as_tibble() %>%
  summarise(length = sum(length))

path.nodes <- test_path_graph %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net, "edges"), col = edge_colors(net), lwd = 1.5) +
  geom_sf(data = test_path_graph %>% activate(edges) %>% as_tibble( ) %>% st_as_sf(), lwd=3, col="#bb3e03") +
  geom_sf(data = st_geometry(net, "nodes"), pch = 20, size = 12, col="black") +
  geom_sf_text(data = net %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
                label = net.nodes$nodeId, col="white") +
  geom_sf_text(data = test_path_graph %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
                label = path.nodes$nodeId, col="white") +
  theme_void()

### Subdivided

net.simple <- as_sfnetwork(lines, directed=FALSE)
net.simple <- net.simple %>% 
  activate("edges") %>% 
  arrange(edge_length()) %>%
  filter(!edge_is_multiple()) %>%
  filter(!edge_is_loop())

net.subdivision <- convert(net.simple, to_spatial_subdivision)
net.subdivision <- net.subdivision %>% activate(edges) %>% mutate(length = edge_length())
net.subdivision <- net.subdivision %>% activate(nodes) %>% arrange(.tidygraph_node_index) %>% mutate(nodeId = c(1:n()))
net.subdivision.nodes <- net.subdivision %>% activate(nodes) %>% as_tibble()


ggplot() +
  geom_sf(data = st_geometry(net.subdivision, "edges"), col = edge_colors(net.subdivision), lwd = 1.5) +
  geom_sf(data = st_geometry(net.subdivision, "nodes"), pch = 20, size = 12, col="black") +
  geom_sf_text(data = net.subdivision %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.subdivision.nodes$nodeId, col="white") +
  theme_void()


test_path <- shortest_paths(
  graph = net.subdivision,
  from = 7,
  to = 1,
  #mode = "all",
  output="both",
  algorithm ="dijkstra", # Ensure to use Dijkstra's algorithm
  weights = net.subdivision %>% activate(edges) %>% pull(length)
)

test_path_graph <- net.subdivision %>%
  subgraph.edges(eids = test_path$epath %>% unlist()) %>%
  as_tbl_graph()

test_path_graph_df <- test_path_graph %>% as_data_frame(., what="vertices")

#Calculate the total length of the path
test_path_graph %>%
  activate(edges) %>%
  as_tibble() %>%
  summarise(length = sum(length))

path.nodes <- test_path_graph %>% activate(nodes) %>% as_tibble()

ggplot() +
  geom_sf(data = st_geometry(net.subdivision, "edges"), col = edge_colors(net.subdivision), lwd = 1.5) +
  geom_sf(data = test_path_graph %>% activate(edges) %>% as_tibble( ) %>% st_as_sf(), lwd=3, col="#bb3e03") +
  geom_sf(data = st_geometry(net.subdivision, "nodes"), pch = 20, size = 12, col="black") +
  geom_sf_text(data = net.subdivision %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = net.subdivision.nodes$nodeId, col="white") +
  geom_sf_text(data = test_path_graph %>% activate(nodes) %>% as_tibble() %>% st_as_sf(), 
               label = path.nodes$nodeId, col="white") +
  theme_void()

```

# Results

## Distance

### All DeSO


```{r map_deso_averages}
top10.travel <- gothenburg.subdiv.merged %>% arrange(desc(avg_dijk_dist)) %>% head(10) %>% st_centroid()
# Plot average distances by DeSO on cloropleth map
ggplot() +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.4) +
  geom_sf(data=gothenburg.subdiv.merged, aes(fill=sqrt(avg_travel_time)), linewidth=0.4) +
  #geom_sf_label(data = central_station, label = central_station$landmark, nudge_y = 0.012, alpha=0.8) +
  geom_sf(data = top10.travel, size=2) +
  #geom_sf_label(data = top10, label=top10$regso)+
  #geom_sf(data =central_station, size=2.8) +
   labs(#title="Average distance to public charging point in Gothenburg",
       #subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Travel time (sqrt)") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous"),
                       breaks = c(seq(0, 6, 1)),
                       na.value="#3B9AB2") +
  theme_custom_map

gothenburg.subdiv.merged %>% arrange(desc(avg_dijk_dist)) %>% head(10)  %>% as_tibble() %>% count(regso)
# caption = str_wrap("Values are shown in a logorithmic scale for better representation of the variences across the DeSOs. X DeSO areas had a average accessibility of zero, which returned infinate in the logorithmic scale. These Nas are shown as the lowest color on the color scale (blue)", 100)


# Table of top 10 results
top10.travel %>% as_tibble() %>% select(deso, regso, nodes, avg_travel_time, -geometry) %>% rownames_to_column(., var="Rank") %>%
  rename(DeSO = "deso", "RegSO" = regso, "Nodes" = nodes, "Avg travel time" = avg_travel_time) %>% 
  stargazer::stargazer(., 
                     type = "latex", 
                     style = "asr",
                     summary = FALSE, 
                     rownames = FALSE,
                     digits = 2,
                     title = "Top 10 DeSOs areas by longest average travel time to public charging point", 
                     notes = "Note: Average travel time is represented in minutes")

```

### Rentals
```{r map_rental_desos}
# Filter out desos by rental majority areas
got.sub.new.rentals <- gothenburg.subdiv.merged %>% 
  filter(deso %in% deso.demographics.rentals$deso)# %>% arrange(desc(avg_dijk_dist))

top10.rental <- got.sub.new.rentals %>% arrange(desc(avg_travel_time)) %>% head(10)  %>% as_tibble()

# Plot average distances by DeSO on heat map
ggplot() +
  #geom_sf(data=gothenburg.subdiv) +
  geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.4) +
  geom_sf(data=got.sub.new.rentals, alpha=1, aes(fill=(avg_travel_time)), linewidth=0.4) +
  geom_sf_label(data = central_station, label = central_station$landmark, nudge_y = 0.012, alpha=0.8) +
  geom_sf(data = central_station, size=2.8) +
  labs(#title="Average distance to public charging point in Gothenburg",
       #subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Travel time (minutes)") +
  scale_fill_gradientn(colors = wes_palette(n=7, name = "Zissou1", type = "continuous"),
                       na.value="#3B9AB2") +
  theme_custom_map

got.sub.new.rentals %>% arrange(desc(avg_travel_time)) %>% head(10)  %>% as_tibble() %>% count(regso)


# Table of top 10 results
top10.rental %>% as_tibble() %>% select(deso, regso, nodes, avg_travel_time, -geometry) %>% rownames_to_column(., var="Rank") %>%
  rename(DeSO = "deso", "RegSO" = regso, "Nodes" = nodes, "Avg travel time" = avg_travel_time) %>% 
  stargazer::stargazer(., 
                     type = "latex", 
                     style = "asr",
                     summary = FALSE, 
                     rownames = FALSE,
                     digits = 2,
                     title = "Top 10 DeSOs areas by longest average travel time to public charging point", 
                     notes = "Note: Average travel time is represented in minutes")
```

## Accessibility

```{r map_all_desos}
top10.accessibility <- gothenburg.subdiv.merged %>% arrange((avg_culm_accessibility)) %>% filter(avg_culm_accessibility == 0)  %>% st_centroid()
# Plot average accessibility by DeSO on map
ggplot() + 
    geom_sf(data=gothenburg.subdiv.merged, alpha=0.9, linewidth=0.4) +
  geom_sf(data = gothenburg.subdiv.merged, aes(fill=sqrt(avg_culm_accessibility)), size=0.4, linewidth=0.2) +
  # geom_sf_label(data = utsatta_områden, label = utsatta_områden$neighbourhood, nudge_y = 0.007, alpha=0.8) +
  # geom_sf(data = utsatta_områden, aes(size=(utsatta_områden$risk_level))) +
  geom_sf(data = top10.accessibility, size=2) +
  #geom_sf_label(data = central_station, label = central_station$landmark, nudge_y = 0.012, alpha=0.8) +
  #geom_sf(data = central_station, size=2.8) +
  labs(#title="Average accessibility to public charging point in Gothenburg",
       #subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Accessibility level") +
  scale_fill_gradientn(colors = rev(wes_palette(n=7, name = "Zissou1", type = "continuous")), 
                       na.value="#F21A00",
                       breaks=c(0:6)) +
theme_custom_map

# Top 10
gothenburg.subdiv.merged %>% arrange((avg_culm_accessibility)) %>% head(10)  %>% as_tibble() %>% count(regso)

# Table of top 10 results
gothenburg.subdiv.merged %>% arrange((avg_culm_accessibility)) %>% filter(avg_culm_accessibility == 0) %>% as_tibble() %>% select(deso, regso, nodes, avg_culm_accessibility, -geometry) %>% rownames_to_column(., var="Rank") %>%
  rename(DeSO = "deso", "RegSO" = regso, "Nodes" = nodes, "Accessibility" = avg_culm_accessibility) %>% 
  stargazer::stargazer(., 
                     type = "text", 
                     style = "asr",
                     summary = FALSE, 
                     rownames = FALSE,
                     digits = 2,
                     title = "Top 10 DeSOs areas by lowest accessibility to public charging point", 
                     notes = "Note: Accessibility stands for the total available charging opportunities with an 8 minute driving radius.")

```

```{r map_rental_desos}
got.sub.new.rentals <- gothenburg.subdiv.merged %>% 
  filter(deso %in% deso.demographics.rentals$deso)
# Plot average accessibility by DeSO on map
ggplot() + 
    geom_sf(data = gothenburg.subdiv.merged, alpha=0.9, linewidth=0.4) +
  geom_sf(data = got.sub.new.rentals, aes(fill=sqrt(avg_culm_accessibility)), size=0.4, linewidth=0.2) +
  # geom_sf_label(data = utsatta_områden, label = utsatta_områden$neighbourhood, nudge_y = 0.007, alpha=0.8) +
  # geom_sf(data = utsatta_områden, aes(size=(utsatta_områden$risk_level))) +
  geom_sf_label(data = central_station, label = central_station$landmark, nudge_y = 0.012, alpha=0.8) +
  geom_sf(data = central_station, size=2.8) +
  labs(#title="Average accessibility to public charging point in Gothenburg",
       #subtitle = "DeSO subdivisions with min 75% rental housing",
       fill = "Accessibility level") +
  scale_fill_gradientn(colors = rev(wes_palette(n=7, name = "Zissou1", type = "continuous")), 
                       na.value="#F21A00",
                       breaks=c(0:6)) +
theme_custom_map

got.sub.new.rentals %>% arrange((avg_culm_accessibility)) %>% head(10) %>% as_tibble() %>% count(regso)


got.sub.new.rentals %>% arrange((avg_culm_accessibility)) %>% head(10) %>% as_tibble() %>% select(deso, regso, nodes, avg_culm_accessibility, -geometry) %>% rownames_to_column(., var="Rank") %>%
  rename(DeSO = "deso", "RegSO" = regso, "Nodes" = nodes, "Accessibility" = avg_culm_accessibility) %>% 
  stargazer::stargazer(., 
                     type = "latex", 
                     style = "asr",
                     summary = FALSE, 
                     rownames = FALSE,
                     digits = 2,
                     title = "Top 10 rental-majority DeSO areas by lowest accessibility to public charging point")

```
 
```{r histogram_desos}
joined_deso.nodes %>% pull(culmulative_accessibility) %>% mean(., na.rm=TRUE)
## Plot map with node points and their color coded distance values
ggplot() +
  #geom_sf(data = streets$osm_lines, linewidth=0.2, color = '#1e00be') +
  #geom_sf(data = main_streets$osm_lines, alpha=0.8, color = "#1e00be", linewidth=0.6) + 
  #geom_sf(data = got.boundary$osm_multipolygons, linewidth=0.5, colour="grey") +
  #geom_sf(data=gothenburg.subdiv, alpha=0.2, linewidth=0.6, colour="transparent", fill="#90C59B")+
  geom_histogram(data = joined_deso.nodes, 
                 fill=wes_palette(n=1, name = "Zissou1"), 
                 aes(x=culmulative_accessibility), binwidth = 1.2) +
  labs(#title="Nodes in Gothenburg City road network graph",
     #subtitle = "By distance to charge point",
     x = "Culmulative accessibility",
     y="") +
  scale_y_continuous(breaks=c(seq(0,30000, 5000))) +
  scale_x_continuous(breaks=c(seq(0, 50, 5))) +
  theme_custom
```
 
## Descriptive Stats

```{r demographics_ds}
# Descriptive stats for full demographic data
deso.demographics %>% 
  rename(#"Totalodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "People per household" = people_per_household,
         "Urban density" = density,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "Higher education" = higher_education,
         "Lower education" = lower_education,
         "Rental apartment" = rental, 
         "Condominium" = condominium, 
         "Owner-occupied house" = housing,
         "Avg cars per household" = cars_per_household,
         "Total registered cars" = cars_on_road) %>%
  select(-deso, -regso, -education_missing, -avg_culm_accessibility, -avg_exposure, -avg_dijk_dist, -avg_travel_time, -nodes) %>% 
  stargazer::stargazer(type="latex", 
                       style="asr",
                       digits=2,
                       omit.summary.stat = c("N", "Sd"), 
                       title = "DeSO demographic data for Gothenburg", 
                       notes = "Data from Statistics Sweden. Recorded 2022.")
  # tbl_summary(., include=c(-ages),
  #             statistic = list(all_continuous() ~ "{mean} ({min}, {max})")) %>%
  #             modify_footnote(all_stat_cols() ~ "Mean (Minimun) (Maximum)") %>%
  #             modify_caption("**Gothenburg city DeSO demographic data (All)** (N = {N})")
```


```{r demographics_ds}
# Sample of summarised demographic data
deso.demographics.rentals %>% arrange((avg_culm_accessibility)) %>% head(5) %>%
  rename(#"Total nodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "DeSO" = deso,
         "ReGSO" = regso,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "People per household" = people_per_household,
         "Urban density" = density,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "Higher education" = higher_education,
         "Lower education" = lower_education,
         "Rental apartment" = rental, 
         "Condominium" = condominium, 
         "Owner-occupied house" = housing,
         "Avg cars per household" = cars_per_household,
         "Total registered cars" = cars_on_road) %>%
  select(-nodes, -education_missing, -avg_culm_accessibility, -avg_dijk_dist, -avg_exposure, -avg_travel_time) %>% 
  stargazer::stargazer(type="latex", 
                       style="asr", 
                       digits = 2, 
                       digits.extra = 0,
                       flip = TRUE,  
                       summary=FALSE, 
                       title = "DeSO demographic data for Gothenburg municipality: Top five most accessible", 
                       notes = "DeSO demographics from 2022.")
```


```{r demographics_ds}
# Sample of summarised demographic data
deso.demographics.rentals %>% arrange((avg_culm_accessibility)) %>% head(5) %>%
  rename(#"Nodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "Higher education" = higher_education,
         "Lower education" = lower_education,
         "Rental apartment" = rental, 
         "Condominium" = condominium, 
         "Owner-occupied house" = housing,
         "Avg cars per household" = cars_per_household) %>%
         #"Total registered cars" = cars_on_road) %>%
  select(-nodes, -education_missing, -avg_accessibility, -avg_culm_accessibility, -avg_dijk_dist, -cars_on_road) %>% 
  stargazer::stargazer(type="text", 
                       style="asr", 
                       digits = 2, 
                       digits.extra = 0,
                       flip = TRUE,  
                       summary=FALSE, 
                       title = "DeSO demographic data for Gothenburg municipality: Sample set", notes = "DeSO demographics from 2022.")
```


```{r demographics_rentals_ds}
# Descriptive stats for rental demographic data
deso.demographics.rentals %>% 
  rename(#"Nodes" = nodes, 
         #"Average distance to PEV charge point" = avg_dijk_dist,
         #"Potential accessibility" = avg_dd_accessibility,
         "Area (m^2)" = area_m2,
         "Population" = pop,
         "Total households" = total_households,
         "Swedish background" = swedish,
         "Foreign background" = foreign,
         "Higher education" = higher_education,
         "Lower education" = lower_education,
         "Rental apartment" = rental, 
         "Condominium" = condominium, 
         "Owner-occupied house" = housing,
         "Avg cars per household" = cars_per_household,
         "Total registered cars" = cars_on_road) %>%
  select(-deso, -regso, -education_missing) %>% 
  tbl_summary(., include=c(-ages),
              statistic = list(all_continuous() ~ "{mean} ({min}, {max})")) %>%
              modify_footnote(all_stat_cols() ~ "Mean (Minimun) (Maximum)") %>%
              modify_caption("**Gothenburg DeSO demographic data
                             (areas with at least 75% rental apartment housing)** (N = {N})")
```

### Knn distance
```{r sample_knn_distance}
# Sample of summarised demographic data
closest_charge_sf  %>%
  rownames_to_column(., "from") %>% mutate(to = charge_id) %>% 
  filter(distance < 1000) %>%
  head() %>% 
  select(from, to, distance) %>%
  stargazer::stargazer(type = "latex", 
                       style = "asr",
                       summary = FALSE, 
                       rownames = FALSE,
                       digits = 0,
                       title = "Euclidean distance between points using K nearest neighbour", 
                       notes = "Note: Nearest neighbour distance is represented in meters")

```

```{r sample_dijk_distance}
# Sample of summarised demographic data Dijkstra's distance
joined_deso.nodes %>% 
  filter(dijkstras_distance < 1000) %>%
  as.data.frame() %>%
  mutate(to = chargeId, from = from_node) %>%
  mutate(dijkstras_distance = as.numeric(dijkstras_distance)) %>%
  select(from, to, dijkstras_distance) %>%
  drop_na() %>% head() %>%
  stargazer::stargazer(type="latex", 
                       style="asr",
                       summary = FALSE, 
                       rownames = FALSE,
                       digits = 0,
                       title = "Shortest distance between points using Dijkstra's algorithm", 
                       notes = "Note: Shortest distance is represented in meters")

```

## Multi-level model

```{r multi_level}

# plot.data.m1 <- coef(model1.accessibility)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# # Scatter plot of coefficients
# ggplot(data=plot.data.m1) + 
#   geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
#   geom_hline(yintercept = random_effects[1,]$estimate, 
#              col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
#   labs(x ="Index",
#        y ="Coefficient") + theme_custom + 
#   theme(axis.ticks.x=element_blank(), 
#         axis.text.x = element_blank(),
#         legend.title = element_blank())

plot.data.m2 <- coef(model2.accessibility)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# Scatter plot of coefficients
ggplot(data=plot.data.m2) + 
  geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
  geom_hline(yintercept = random_effects2[1,]$estimate,
             col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
  labs(x ="Index",
       y ="Coefficient") + theme_custom + 
  theme(axis.ticks.x=element_blank(), 
        axis.text.x = element_blank(),
        legend.title = element_blank())

plot.data.m4 <- coef(model4.accessibility)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# Scatter plot of coefficients
ggplot(data=plot.data.m4) + 
  geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
  geom_hline(yintercept = random_effects4[1,]$estimate,
             col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
  labs(x ="Index",
       y ="Coefficient") + theme_custom + 
  theme(axis.ticks.x=element_blank(), 
        axis.text.x = element_blank(),
        legend.title = element_blank())
```
### Scatter plots
```{r multi_level-traveltime}

# plot.data.m1 <- coef(model1.traveltime)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# # Scatter plot of coefficients
# ggplot(data=plot.data.m1) + 
#   geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
#   geom_hline(yintercept = random_effects.tt[1,]$estimate, 
#              col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
#   labs(x ="Index",
#        y ="Coefficient") + theme_custom + 
#   theme(axis.ticks.x=element_blank(), 
#         axis.text.x = element_blank(),
#         legend.title = element_blank())

plot.data.m2 <- coef(model2.traveltime)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# Scatter plot of coefficients
ggplot(data=plot.data.m2) + 
  geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
  geom_hline(yintercept = random_effects2.tt[1,]$estimate,
             col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
  labs(x ="Index",
       y ="Coefficient") + theme_custom + 
  theme(axis.ticks.x=element_blank(), 
        axis.text.x = element_blank(),
        legend.title = element_blank())

plot.data.m4 <- coef(model4.traveltime)$deso %>% tibble() %>% mutate(coef = `(Intercept)`) %>% rownames_to_column(., "index")
# Scatter plot of coefficients
ggplot(data=plot.data.m4) + 
  geom_point(aes(x=index, y=coef), col=wes_palette(n=1,"Zissou1")) +
  geom_hline(yintercept = random_effects4.tt[1,]$estimate,
             col=wes_palette(n=2,"GrandBudapest1")[2], size=1) +
  labs(x ="Index",
       y ="Coefficient") + theme_custom + 
  theme(axis.ticks.x=element_blank(), 
        axis.text.x = element_blank(),
        legend.title = element_blank())
```

### Tables

```{r modelcombined}
random_effects1 <- tidy(M1) %>% filter(group %in% c("deso", "Residual")) #as.data.frame(VarCorr(model2.mm))[1,]
random_effects2 <- tidy(M2) %>% filter(group %in% c("deso", "Residual")) #as.data.frame(VarCorr(model2.mm))[1,]

variance1 <- get_variance(M1)
variance2 <- get_variance(M2)

random_effects3.tt <- tidy(M3) %>% filter(group %in% c("deso", "Residual")) #as.data.frame(VarCorr(model2.mm))[1,]
random_effects4.tt <- tidy(M4) %>% filter(group %in% c("deso", "Residual")) #as.data.frame(VarCorr(model2.mm))[1,]

variance3.tt <- get_variance(M3)
variance4.tt <- get_variance(M4)

model_list.combined <- list(M1, M2, M3, M4)
stargazer(model_list.combined,
          type = "latex", # Choose output format (text, latex, html)
          title = "Multi-level Poisson Regression Model Results",
          digits = 3,    # Number of digits to display
          add.lines = list(#c("REML criterion", round(glmerMod(model1.mm.pois), 2), round(REMLcrit(model2.mm.pois), 2)),
                           c("Random Effects:"),
                           c("- DeSO Intercept", 
                             paste0(format(variance1$var.intercept, digits = 3), " (", 
                                    format(random_effects1[1,]$estimate, digits = 3), ")"), 
                             paste0(format(variance2$var.intercept, digits = 3), " (", 
                                    format(random_effects2[1,]$estimate, digits = 3), ")"),
                             paste0(format(variance3.tt$var.intercept, digits = 3), " (", 
                                    format(random_effects3.tt[1,]$estimate, digits = 3), ")"),
                             paste0(format(variance4.tt$var.intercept, digits = 3), " (", 
                                    format(random_effects4.tt[1,]$estimate, digits = 3), ")"))),
          align = FALSE,
          model.numbers = FALSE,
          column.sep.width = "-5pt",
          font.size = "small", 
          covariate.labels = c("Closeness centrality", "Foreign background", "Median income", "Rental", "Urban density", "Foreign bg:Rental", "Median income:Rental"),
          dep.var.labels = c("Accessibility"),
          column.labels = c("Model 1", "Model 2", "Model 3", "Model 4")) # Align output
```


## Correlation Matrix Plot

```{r correlation_plot}
# Plot correlation matrix
  ggcorrplot(corr_matrix, 
           #title = "Correlation matrix, GOT DeSO demographic data",
           method = "square",
           lab = TRUE, # Stat values
           lab_size = 2.4,
           hc.order = TRUE,
           type = "upper",
           outline.color = "white",
           ggtheme = ggplot2::theme_minimal,
           pch = 1, 
           legend.title = "Correlation",
           pch.col = "black", 
           pch.cex =1,
           tl.cex = 14) +
  theme(legend.title = element_text(family = "Cambria"),
        legend.text = element_text(family = "Cambria"),
        axis.text.x = element_text(family = "Cambria", 
                                   margin=margin(0,0,0,0),
                                   angle = 65,
                                   size = 10),
        axis.text.y = element_text(family = "Cambria", 
                                   margin=margin(0,-2,0,0),
                                   size=10)) +
  geom_vline(xintercept=1:ncol(deso.demographics)-0.5, colour="white", size=1) +
  geom_hline(yintercept=1:ncol(deso.demographics)-0.5, colour="white", size=1)
```

